---
# tasks file for pelorus-prereqs
- name: Install prerequisites
  block:
  - name: Install the latest version of openssl
    dnf:
      name: openssl
      state: latest
    become: yes
    become_user: root

  - name: Download Helm 3
    get_url:
        url: https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
        dest: /tmp/get_helm.sh
        mode: '0700'

  - name: Install Helm 3
    ansible.builtin.shell: /tmp/get_helm.sh >> /tmp/somelog.txt

  - name: Install the latest version of jq
    dnf:
      name: jq
      state: latest
    become: yes
    become_user: root

  - name: Git checkout Pelorus repo
    ansible.builtin.git:
      repo: 'https://github.com/konveyor/pelorus.git'
      dest: /tmp/checkout

  - name: Download and unarchive OC client tool
    unarchive:
      src: https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz
      dest: /usr/local/bin
      remote_src: True
  
  - name: Install requests-oauthlib python package
    pip:
      name: requests-oauthlib
      extra_args: --user

  - name: Install openshift python package
    pip:
      name: openshift
      extra_args: --user

  always:
    - name: If login succeeded, try to log out (revoke access token)
      when: k8s_auth_results.k8s_auth.api_key is defined
      k8s_auth:
        state: absent
        api_key: "{{ k8s_auth_results.k8s_auth.api_key }}"
