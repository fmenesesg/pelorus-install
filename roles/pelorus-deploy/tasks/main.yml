---
# tasks file for pelorus-deploy
- python_requirements_info:
        dependencies:
          - openshift
          - requests

- name: Deployment of Pelorus core stack on OCP
  block:
  - name: Log in (obtain access token)
    k8s_auth:
      username: "{{ username }}"
      password: "{{ password }}"
    register: k8s_auth_results

  - name: Create {{ pelorus_project_name }} namespace
    k8s:
      api_key: "{{ k8s_auth_results.k8s_auth.api_key }}"
      name: "{{ pelorus_project_name }}"
      api_version: v1
      kind: Namespace
      state: present

  - name: Get htpasswd secret
    k8s_info:
      api_key: "{{ k8s_auth_results.k8s_auth.api_key }}"
      api_version: v1
      kind: Secret
      name: htpasswd-secret
      namespace: openshift-config
    register: htpasswd_secret

  - name: Debug
    ansible.builtin.debug:
      msg: "{{ htpasswd_secret.resources[0] | to_nice_yaml }}"

  - local_action: copy content="{{ htpasswd_secret.resources[0] | to_nice_yaml }}" dest='{{ role_path }}/files/htpasswd-secret.yml'

  always:
  - name: If login succeeded, try to log out (revoke access token)
    when: k8s_auth_results.k8s_auth.api_key is defined
    k8s_auth:
      state: absent
      api_key: "{{ k8s_auth_results.k8s_auth.api_key }}"

